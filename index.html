<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shaka Player - Advanced Test</title>
    <style>
        body { font-family: sans-serif; text-align: center; background-color: #222; color: white; }
        video { width: 80%; max-width: 800px; margin-top: 20px; border: 2px solid #333; }
        #error-log { margin-top: 20px; color: #ff6b6b; font-family: monospace; }
    </style>
    <!-- Use the compiled Shaka Player library (no UI) for simplicity -->
    <script src="https://ajax.googleapis.com/ajax/libs/shaka-player/4.16.9/shaka-player.compiled.js"></script>
</head>
<body>

    <h1>Shaka Player Test</h1>
    <video id="video" controls autoplay></video>
    <div id="error-log"></div>

    <script>
        // --- CONFIGURATION ---

        // Original manifest URL
        let manifestUri = 'https://linearjitp-playback.astro.com.my/dash-wv/linear/500/default_ott.mpd';
        
        // **CORS PROXY (IF NEEDED)**
        // If you see a CORS error in the console, uncomment the line below to use a proxy.
        // This is for testing only, as public proxies can be unreliable.
        // manifestUri = 'https://cors-anywhere.herokuapp.com/' + manifestUri;

        // Custom User-Agent from your M3U8 file
        const customUserAgent = 'Mozilla/5.0 (Linux; Android 14; 27821-67832-42-315-4231-233-21-43-12-1312-321-23-21-232-) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/133.0.0.0 Mobile Safari/537.36';

        // Key details (converted from Base64 to Hex)
        const kid_hex = '346b9f41e2933748c8861f82932e0110';
        const k_hex = 'cf0cffb637b81598a27bd6b0d90d65a8';

        // --- PLAYER INITIALIZATION ---

        async function initPlayer() {
            const video = document.getElementById('video');
            const player = new shaka.Player(video);

            // Listen for errors from the player
            player.addEventListener('error', onPlayerError);

            // Configure the networking engine to use the custom User-Agent
            player.getNetworkingEngine().registerRequestFilter((type, request) => {
                // We only need to modify MANIFEST and SEGMENT requests
                if (type === shaka.net.NetworkingEngine.RequestType.MANIFEST || type === shaka.net.NetworkingEngine.RequestType.SEGMENT) {
                    request.headers['User-Agent'] = customUserAgent;
                }
            });

            // Configure the DRM with ClearKeys
            player.configure({
                drm: {
                    clearKeys: {
                        [kid_hex]: k_hex
                    }
                }
            });

            // Try to load the manifest and start playback
            try {
                console.log('Attempting to load manifest:', manifestUri);
                await player.load(manifestUri);
                console.log('Playback started successfully!');
            } catch (e) {
                onPlayerError(e);
            }
        }

        function onPlayerError(error) {
            // Log the detailed error to the console and the screen
            console.error('Shaka Player Error:', error.detail);
            const errorLog = document.getElementById('error-log');
            errorLog.innerText = `Error Code: ${error.detail.code}\nMessage: ${error.detail.message}`;
        }

        // Wait for the page to load before starting the player
        document.addEventListener('DOMContentLoaded', initPlayer);
    </script>

</body>
</html>
